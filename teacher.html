<!-- teacher.html -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teacher Dashboard - BVSD Classroom Scheduler</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="section-padded centered-content">

  <h1 class="section-title">Teacher Dashboard</h1>
  <div style="max-width:1100px; width:100%;">
    <div id="welcome" style="text-align:center; margin-bottom:8px;"></div>

    <section>
      <h2>Your Classroom: <span id="classroom-name" style="color:#00bfff;"></span></h2>
      <div id="classroom-status"></div>
      <button id="create-classroom" class="carousel-button" style="display:none; margin-top:8px;">Create Classroom</button>
    </section>

    <section style="margin-top:18px;">
      <h2 class="section-title">Transfers</h2>
      <div style="display:flex; gap:20px; flex-wrap:wrap;">
        <div style="flex:1; min-width:320px;">
          <h3 style="color:#00bfff;">Check Out — Students leaving your homeroom</h3>
          <div id="checkout-list" style="background:#0b0b0b; padding:10px; border-radius:8px; min-height:120px;"></div>
        </div>
        <div style="flex:1; min-width:320px;">
          <h3 style="color:#00bfff;">Check In — Incoming students</h3>
          <div id="incoming-pending" style="background:#0b0b0b; padding:8px; border-radius:8px; min-height:80px; margin-bottom:8px;">
            <strong style="color:#9aa">Waiting for home teacher to check out</strong>
            <div id="incoming-pending-list"></div>
          </div>
          <div id="incoming-ready" style="background:#0b0b0b; padding:8px; border-radius:8px; min-height:80px;">
            <strong style="color:#9aa">Ready to Check In</strong>
            <div id="incoming-ready-list"></div>
          </div>
        </div>
      </div>
    </section>

    <section style="margin-top:18px;">
      <h2 class="section-title">Search & Add Students</h2>
      <input id="search-input" placeholder="Search by first, last, grade..." style="width:100%; padding:10px; border-radius:8px; border:1px solid #00bfff;">
      <div id="search-results" style="margin-top:10px; background:#0b0b0b; padding:8px; border-radius:8px; max-height:320px; overflow:auto;"></div>
    </section>

    <section style="margin-top:18px;">
      <h2 class="section-title">Roster</h2>
      <div id="roster-list" style="background:#0b0b0b; padding:8px; border-radius:8px; max-height:300px; overflow:auto;"></div>
    </section>

    <section style="margin-top:18px;">
      <h2 class="section-title">Requests involving you</h2>
      <div id="queue-list" style="background:#0b0b0b; padding:8px; border-radius:8px; max-height:200px; overflow:auto;"></div>
    </section>

    <div style="text-align:center; margin-top:12px;">
      <a href="initial.html" class="carousel-button">Edit Initial Roster</a>
    </div>
  </div>

<script>
  // CONFIG: set this to your Apps Script web app exec URL
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxPZStDXB4MnWTGtPgWcXkMQFzvqf-vBYbUD1zTo3Ta6UkSdkaHwikzvAvNZI533Zauyg/exec';

  function api(action, params = {}) {
    params.action = action;
    const q = new URLSearchParams(params).toString();
    return fetch(`${WEB_APP_URL}?${q}`).then(r => r.json());
  }

  const userName = sessionStorage.getItem('userName') || '';
  if (!userName) location.href = 'login.html';
  document.getElementById('welcome').innerHTML = `<p>Welcome, <strong>${escapeHtml(userName)}</strong></p>`;
  document.getElementById('classroom-name').textContent = userName;

  const createBtn = document.getElementById('create-classroom');
  const statusEl = document.getElementById('classroom-status');
  const checkoutList = document.getElementById('checkout-list');
  const incomingPendingList = document.getElementById('incoming-pending-list');
  const incomingReadyList = document.getElementById('incoming-ready-list');
  const searchInput = document.getElementById('search-input');
  const searchResults = document.getElementById('search-results');
  const rosterList = document.getElementById('roster-list');
  const queueList = document.getElementById('queue-list');

  async function init() {
    statusEl.textContent = 'Checking classroom...';
    const chk = await api('checkClassroom', { classroom: userName });
    if (chk.exists) { statusEl.textContent = 'Classroom loaded'; createBtn.style.display = 'none'; } else { statusEl.textContent = 'No classroom yet'; createBtn.style.display = 'inline-block'; }

    createBtn.addEventListener('click', async () => {
      createBtn.disabled = true;
      const res = await api('createClassroom', { classroom: userName });
      createBtn.disabled = false;
      if (res.success) location.href = 'initial.html';
      else alert(res.message || 'Failed to create classroom');
    });

    searchInput.addEventListener('input', debounce(async e => {
      const q = e.target.value.trim();
      if (q.length < 2) { searchResults.innerHTML = '<div style="padding:8px;color:#aaa">Type 2+ chars</div>'; return; }
      searchResults.innerHTML = '<div style="padding:8px;color:#aaa">Searching...</div>';
      const r = await api('searchStudents', { query: q });
      if (!r || !r.students || r.students.length === 0) { searchResults.innerHTML = '<div style="padding:8px;color:#aaa">No results</div>'; return; }
      searchResults.innerHTML = r.students.map(s => studentRowHtml(s)).join('');
    }, 300));

    searchResults.addEventListener('click', async ev => {
      const btn = ev.target.closest('.request-btn');
      if (!btn) return;
      const id = btn.dataset.id, first = btn.dataset.first, last = btn.dataset.last, grade = btn.dataset.grade;
      const parent = btn.closest('.student-row');
      const timesSel = parent.querySelector('.times');
      const priSel = parent.querySelector('.priority');
      const times = timesSel ? timesSel.value : '1';
      const priority = priSel ? priSel.value : 'not important';
      btn.disabled = true; btn.textContent = 'Adding...';
      const res = await api('addStudentRequest', { teacherName: userName, studentId: id, firstName: first, lastName: last, grade, times, priority });
      // close / remove the student row after adding (per your request)
      parent.remove();
      await refreshAll();
      if (res.assigned) alert('Assigned to you (will appear in roster; checkedOut = FALSE until home teacher releases if homeroom).');
      else if (res.queued) alert('Student is assigned to someone else — request queued for home teacher to check out.');
      else alert(res.message || 'Done');
    });

    document.body.addEventListener('click', async ev => {
      const cbtn = ev.target.closest('.checkout-btn');
      if (cbtn) {
        const row = cbtn.dataset.row;
        cbtn.disabled = true; cbtn.textContent = 'Checking out...';
        const res = await api('checkoutRequest', { requestRow: row, teacherName: userName });
        cbtn.disabled = false; cbtn.textContent = 'Check Out';
        if (!res.success) alert('Error: ' + (res.message || 'unknown')); else alert(res.message || 'Checked out');
        await refreshAll();
      }
      const inBtn = ev.target.closest('.checkin-btn');
      if (inBtn) {
        const studentId = inBtn.dataset.id;
        inBtn.disabled = true; inBtn.textContent = 'Checking in...';
        const res = await api('checkinStudent', { studentId, teacherName: userName });
        inBtn.disabled = false; inBtn.textContent = 'Check In';
        if (!res.success) alert('Error: ' + (res.message || 'unknown'));
        else {
          alert(res.message || 'Checked in');
          if (res.promoted && res.promoted.promoted) {
            console.log('Suggested next pending:', res.promoted);
          }
        }
        await refreshAll();
      }
    });

    await refreshAll();
  }

  async function refreshAll() {
    await loadTransfers();
    await loadRoster();
    await loadQueue();
  }

  async function loadTransfers() {
    checkoutList.innerHTML = '<div style="padding:8px;color:#aaa">Loading...</div>';
    incomingPendingList.innerHTML = '';
    incomingReadyList.innerHTML = '';
    const resp = await api('getTransfers', { teacher: userName });
    if (resp.checkout && resp.checkout.length) {
      checkoutList.innerHTML = resp.checkout.map(e => `
        <div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;justify-content:space-between;align-items:center;">
          <div><strong>${escapeHtml(e.firstName)} ${escapeHtml(e.lastName)}</strong><div style="color:#9aa">To: ${escapeHtml(e.toTeacher)} • Priority: ${escapeHtml(e.priority)}</div></div>
          <div><button class="checkout-btn carousel-button" data-row="${escapeHtml(e.rowIndex)}">Check Out</button></div>
        </div>
      `).join('');
    } else checkoutList.innerHTML = '<div style="padding:8px;color:#aaa">No outgoing requests.</div>';

    if (resp.incomingPending && resp.incomingPending.length) {
      incomingPendingList.innerHTML = resp.incomingPending.map(e => `<div style="padding:6px;border-bottom:1px dashed rgba(255,255,255,0.02)">${escapeHtml(e.firstName)} ${escapeHtml(e.lastName)} • From: ${escapeHtml(e.fromTeacher)} • Priority: ${escapeHtml(e.priority)}</div>`).join('');
    } else incomingPendingList.innerHTML = '<div style="padding:6px;color:#aaa">No incoming requests waiting.</div>';

    if (resp.incomingReady && resp.incomingReady.length) {
      incomingReadyList.innerHTML = resp.incomingReady.map(a => `
        <div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;justify-content:space-between;align-items:center;">
          <div><strong>${escapeHtml(a.firstName)} ${escapeHtml(a.lastName)}</strong><div style="color:#9aa">Times remaining: ${escapeHtml(a.timesRemaining)} • Priority: ${escapeHtml(a.priority)}</div></div>
          <div><button class="checkin-btn carousel-button" data-id="${escapeHtml(a.studentId)}">Check In</button></div>
        </div>
      `).join('');
    } else incomingReadyList.innerHTML = '<div style="padding:6px;color:#aaa">No students ready to check in.</div>';
  }

  async function loadRoster() {
    rosterList.innerHTML = '<div style="padding:8px;color:#aaa">Loading roster...</div>';
    const r = await api('getClassroom', { teacher: userName });
    if (!r || !r.students || r.students.length === 0) { rosterList.innerHTML = '<div style="padding:8px;color:#aaa">No students assigned to your classroom.</div>'; return; }
    rosterList.innerHTML = r.students.map(s => `
      <div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);">
        <strong>${escapeHtml(s.firstName)} ${escapeHtml(s.lastName)}</strong>
        <div style="color:#9aa">Grade ${escapeHtml(s.grade)} • Status: ${escapeHtml(s.status || 'in')} ${s.isInitial ? '• (Initial)' : ''} ${s.outTo ? '• Out to: ' + escapeHtml(s.outTo) : ''}</div>
      </div>
    `).join('');
  }

  async function loadQueue() {
    const q = await api('getQueue', { teacher: userName });
    if (!q || !q.queue || q.queue.length === 0) { queueList.innerHTML = '<div style="padding:8px;color:#aaa">No requests.</div>'; return; }
    queueList.innerHTML = q.queue.map(e => `<div style="padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03)"><strong>${escapeHtml(e.firstName)} ${escapeHtml(e.lastName)}</strong><div style="color:#9aa">From: ${escapeHtml(e.fromTeacher)} → To: ${escapeHtml(e.toTeacher)} • ${escapeHtml(e.priority)}</div></div>`).join('');
  }

  function studentRowHtml(s) {
    return `
      <div class="student-row" data-id="${escapeHtml(s.id)}" data-first="${escapeHtml(s.firstName)}" data-last="${escapeHtml(s.lastName)}" data-grade="${escapeHtml(s.grade)}" style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.03); display:flex; justify-content:space-between; align-items:center;">
        <div>
          <strong>${escapeHtml(s.firstName)} ${escapeHtml(s.lastName)}</strong><br><small style="color:#9aa">Grade ${escapeHtml(s.grade)}</small>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <select class="times" style="padding:6px; border-radius:6px;">
            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
          </select>
          <select class="priority" style="padding:6px; border-radius:6px;">
            <option value="not important">Not Important</option>
            <option value="important">Important</option>
            <option value="critical">Critical</option>
          </select>
          <button class="request-btn carousel-button" data-id="${escapeHtml(s.id)}" data-first="${escapeHtml(s.firstName)}" data-last="${escapeHtml(s.lastName)}" data-grade="${escapeHtml(s.grade)}">Add</button>
        </div>
      </div>
    `;
  }

  function debounce(fn, ms) { let t; return function() { clearTimeout(t); const args = arguments; t = setTimeout(() => fn.apply(this, args), ms); }; }
  function escapeHtml(s) { return (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

  init();
</script>

</body>
</html>
